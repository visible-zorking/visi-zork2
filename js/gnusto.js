String.prototype.quote=function(){var t,e,_=this.length,r='"';for(e=0;e<_;e+=1)if((t=this.charAt(e))>=" ")"\\"!==t&&'"'!==t||(r+="\\"),r+=t;else switch(t){case"\b":r+="\\b";break;case"\f":r+="\\f";break;case"\n":r+="\\n";break;case"\r":r+="\\r";break;case"\t":r+="\\t";break;default:t=t.charCodeAt(),r+="\\u00"+Math.floor(t/16).toString(16)+(t%16).toString(16)}return r+'"'};var GnustoRunner=Object.subClass({init:function(t){this._classname="GnustoRunner(g)";window.engine=this.e=new GnustoEngine(function(t){console.log(t)});this.io=new GlkIOClass(t,this),this.commentary=new CommentaryClass},load:function(t){engine.loadStory(t)},createSaveFiles:function(t){for(var e of t)this.io.create_save_file(e.name,e.data)},startGame:function(){this.orders=[],this.ui=new ZVMUI(this,0x02&engine.getByte(0x11)),this.orders=[],this.io.init()},run:function(){var t,e,_,r,s,n,i=this.e,a=this.ui;for(this.orders=[],i.reset_vm_report();!s;){try{i.run()}catch(t){this.io.error(t);break}if((t=i.consoleText())&&(a.buffer+=t),e='"'+i.effect(0)+'"',_=i.effect(1),r=i.effect(2),e==GNUSTO_EFFECT_INPUT&&(s=1,a.flush(),this.orders.push({code:"read",target:this.currentwin,maxlen:i.effect(3)})),e==GNUSTO_EFFECT_INPUT_CHAR&&(s=1,this.orders.push({code:"char"})),e==GNUSTO_EFFECT_SAVE&&(s=1,i.saveGame(),this.orders.push({code:"save",data:i.saveGameData()})),e==GNUSTO_EFFECT_RESTORE&&(s=1,this.orders.push({code:"restore"})),e==GNUSTO_EFFECT_QUIT&&(s=1,this.orders.push({code:"quit"})),e==GNUSTO_EFFECT_RESTART&&this.io.error("RESTART effect not used"),e==GNUSTO_EFFECT_FLAGS_CHANGED&&(a.flush(),a.mono=0xFD&a.mono|0x2&i.m_printing_header_bits),e==GNUSTO_EFFECT_STYLE&&(_<0?a.set_colour(r,i.effect(3)):a.set_style(_)),e==GNUSTO_EFFECT_SPLITWINDOW&&a.split_window(_),e==GNUSTO_EFFECT_SETWINDOW&&a.set_window(_),e==GNUSTO_EFFECT_ERASEWINDOW&&a.erase_window(_),e==GNUSTO_EFFECT_ERASELINE&&a.erase_line(_),e==GNUSTO_EFFECT_SETCURSOR&&a.set_cursor(_,r),e==GNUSTO_EFFECT_GETCURSOR&&(s=1,a.get_cursor(_)),e==GNUSTO_EFFECT_PRINTTABLE)for(n=0;n<_;n++)a.buffer+="\n"+i.effect(2+n)}return a.flush(),a.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),a.status=[]),this.commentary.hide(),window.dispatchEvent(new Event("zmachine-update")),this.orders},act:function(){}}),CVS_VERSION="$Date: 2005/04/26 01:50:32 $",ENGINE_DESCRIPTION="Gnusto's interactive fiction engine",default_unicode_translation_table={155:0xe4,156:0xf6,157:0xfc,158:0xc4,159:0xd6,160:0xdc,161:0xdf,162:0xbb,163:0xab,164:0xeb,165:0xef,166:0xff,167:0xcb,168:0xcf,169:0xe1,170:0xe9,171:0xed,172:0xf3,173:0xfa,174:0xfd,175:0xc1,176:0xc9,177:0xcd,178:0xd3,179:0xda,180:0xdd,181:0xe0,182:0xe8,183:0xec,184:0xf2,185:0xf9,186:0xc0,187:0xc8,188:0xcc,189:0xd2,190:0xd9,191:0xe2,192:0xea,193:0xee,194:0xf4,195:0xfb,196:0xc2,197:0xca,198:0xce,199:0xd4,200:0xdb,201:0xe5,202:0xc5,203:0xf8,204:0xd8,205:0xe3,206:0xf1,207:0xf5,208:0xc3,209:0xd1,210:0xd5,211:0xe6,212:0xc6,213:0xe7,214:0xc7,215:0xfe,216:0xf0,217:0xde,218:0xd0,219:0xa3,220:0x153,221:0x152,222:0xa1,223:0xbf},reverse_unicode_table={},isNotConst=/\D/,temp_var=0,PARENT_REC=0,SIBLING_REC=1,CHILD_REC=2,CALLED_FROM_INTERRUPT=0,dummy,t,t2;window||(this.window={});var PARCHMENT_SECURITY_OVERRIDE=window.PARCHMENT_SECURITY_OVERRIDE,GNUSTO_EFFECT_INPUT='"RS"',GNUSTO_EFFECT_INPUT_CHAR='"RC"',GNUSTO_EFFECT_SAVE='"DS"',GNUSTO_EFFECT_RESTORE='"DR"',GNUSTO_EFFECT_QUIT='"QU"',GNUSTO_EFFECT_RESTART='"NU"',GNUSTO_EFFECT_WIMP_OUT='"WO"',GNUSTO_EFFECT_BREAKPOINT='"BP"',GNUSTO_EFFECT_FLAGS_CHANGED='"XC"',GNUSTO_EFFECT_PIRACY='"CP"',GNUSTO_EFFECT_STYLE='"SS"',GNUSTO_EFFECT_SOUND='"FX"',GNUSTO_EFFECT_SPLITWINDOW='"TW"',GNUSTO_EFFECT_SETWINDOW='"SW"',GNUSTO_EFFECT_ERASEWINDOW='"YW"',GNUSTO_EFFECT_ERASELINE='"YL"',GNUSTO_EFFECT_SETCURSOR='"SC"',GNUSTO_EFFECT_SETBUFFERMODE='"SB"',GNUSTO_EFFECT_SETINPUTSTREAM='"SI"',GNUSTO_EFFECT_GETCURSOR='"GC"',GNUSTO_EFFECT_PRINTTABLE='"PT"';function label_for_effect(t){switch(t){case GNUSTO_EFFECT_INPUT:return"INPUT";case GNUSTO_EFFECT_INPUT_CHAR:return"INPUT_CHAR";case GNUSTO_EFFECT_SAVE:return"SAVE";case GNUSTO_EFFECT_RESTORE:return"RESTORE";case GNUSTO_EFFECT_QUIT:return"QUIT";case GNUSTO_EFFECT_RESTART:return"RESTART";case GNUSTO_EFFECT_WIMP_OUT:return"WIMP_OUT";case GNUSTO_EFFECT_BREAKPOINT:return"BREAKPOINT";case GNUSTO_EFFECT_FLAGS_CHANGED:return"FLAGS_CHANGED";case GNUSTO_EFFECT_PIRACY:return"PIRACY";case GNUSTO_EFFECT_STYLE:return"STYLE";case GNUSTO_EFFECT_SOUND:return"SOUNBD";case GNUSTO_EFFECT_SPLITWINDOW:return"SPLITWINDOW";case GNUSTO_EFFECT_SETWINDOW:return"SETWINDOW";case GNUSTO_EFFECT_ERASEWINDOW:return"ERASEWINDOW";case GNUSTO_EFFECT_ERASELINE:return"ERASELINE";case GNUSTO_EFFECT_SETCURSOR:return"SETCURSOR";case GNUSTO_EFFECT_SETBUFFERMODE:return"SETBUFFERMODE";case GNUSTO_EFFECT_SETINPUTSTREAM:return"SETINPUTSTREAM";case GNUSTO_EFFECT_GETCURSOR:return"GETCURSOR";case GNUSTO_EFFECT_PRINTTABLE:return"PRINTTABLE";default:return t}}function handleZ_je(t,e){if(e.length<2)return"";if(2==e.length)return t._brancher(e[0]+"=="+e[1]);for(var _="",r=1;r<e.length;r++)1!=r&&(_+="||"),_=_+"t=="+e[r];return"t="+e[0]+";"+t._brancher(_)}function handleZ_jl(t,e){return(isNotConst.test(e[0])?"t="+e[0]+";t=((t & 0x8000 ? ~0xFFFF : 0) | t);":"t="+t._unsigned2signed(e[0])+";")+(isNotConst.test(e[1])?"t2="+e[1]+";t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);":"t2="+t._unsigned2signed(e[1])+";")+t._brancher("t<t2")}function handleZ_jg(t,e){return(isNotConst.test(e[0])?"t="+e[0]+";t=((t & 0x8000 ? ~0xFFFF : 0) | t);":"t="+t._unsigned2signed(e[0])+";")+(isNotConst.test(e[1])?"t2="+e[1]+";t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);":"t2="+t._unsigned2signed(e[1])+";")+t._brancher("t>t2")}function handleZ_inc_chk(t,e){var _=handleZ_inc(t,e);return _+="{var t1=incdec; t1 = ((t1 & 0x8000 ? ~0xFFFF : 0) | t1); var t2="+e[1]+"; t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);"+t._brancher("t1 > t2")+"}"}function handleZ_dec_chk(t,e){var _=handleZ_dec(t,e);return _+="{var t1=incdec; t1 = ((t1 & 0x8000 ? ~0xFFFF : 0) | t1); var t2="+e[1]+"; t2=((t2 & 0x8000 ? ~0xFFFF : 0) | t2);"+t._brancher("t1 < t2")+"}"}function handleZ_jin(t,e){return t._brancher("_obj_in("+e[0]+","+e[1]+")")}function handleZ_test(t,e){return"t="+e[1]+";"+t._brancher("("+e[0]+"&t)==t")}function handleZ_or(t,e){return t._storer("("+e[0]+"|"+e[1]+")")}function handleZ_and(t,e){return t._storer("("+e[0]+"&"+e[1]+")")}function handleZ_test_attr(t,e){return t._brancher("_test_attr("+e[0]+","+e[1]+")")}function handleZ_set_attr(t,e){return"_set_attr("+e[0]+","+e[1]+")"}function handleZ_clear_attr(t,e){return"_clear_attr("+e[0]+","+e[1]+")"}function handleZ_store(t,e){return isNaN(e[0])?"("+e[0]+" == 0) ? m_gamestack[m_gamestack.length - 1] = "+e[1]+" : ("+e[0]+" < 0x10) ? m_locals[( "+e[0]+" - 1 )] = "+e[1]+" : setWord("+e[1]+", m_vars_start + ( "+e[0]+" - 16 ) * 2 )":0==e[0]?"m_gamestack[m_gamestack.length - 1] = "+e[1]:e[0]<0x10?"m_locals[( "+e[0]+" - 1 )] = "+e[1]:"setWord("+e[1]+", m_vars_start + ( "+e[0]+" - 16 ) * 2 )"}function handleZ_insert_obj(t,e){return"_insert_obj("+e[0]+","+e[1]+")"}function handleZ_loadw(t,e){if(isNotConst.test(e[0])||isNotConst.test(e[1]))var _="var tmp_"+ ++temp_var+" = ("+e[0]+" + 2 * "+e[1]+") & 0xFFFF, ",r=(s="tmp_"+temp_var)+"+1";else{var s;_="var ",r=(s=e[0]+2*e[1]&0xFFFF)+1}var n="tmp_"+ ++temp_var;return _+n+" = (m_memory["+s+"] << 8) | m_memory["+r+"];"+t._storer(n)}function handleZ_loadb(t,e){return t._storer("m_memory[0xFFFF&("+e[0]+"+"+e[1]+")]")}function handleZ_get_prop(t,e){return t._storer("_get_prop("+e[0]+","+e[1]+")")}function handleZ_get_prop_addr(t,e){return t._storer("_get_prop_addr("+e[0]+","+e[1]+")")}function handleZ_get_next_prop(t,e){return t._storer("_get_next_prop("+e[0]+","+e[1]+")")}function handleZ_add(t,e){return t._storer("("+e[0]+" + "+e[1]+") & 0xFFFF")}function handleZ_sub(t,e){return t._storer("("+e[0]+" - "+e[1]+") & 0xFFFF")}function handleZ_mul(t,e){return t._storer("("+e[0]+"*"+e[1]+") & 0xFFFF")}function handleZ_div(t,e){return t._storer("_trunc_divide("+e[0]+","+e[1]+")")}function handleZ_mod(t,e){return t._storer("_trunc_modulo("+e[0]+","+e[1]+")")}function handleZ_set_colour(t,e){return"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_STYLE+",-1,"+e[0]+","+e[1]+"];return"}function handleZ_throw(t,e){return t.m_compilation_running=0,"_throw_stack_frame("+e[0]+");return"}function handleZ_jz(t,e){return t._brancher(e[0]+"==0")}function handleZ_get_sibling(t,e){return"t=_get_sibling("+e[0]+");"+t._storer("t")+";"+t._brancher("t")}function handleZ_get_child(t,e){return"t=_get_child("+e[0]+");"+t._storer("t")+";"+t._brancher("t")}function handleZ_get_parent(t,e){return t._storer("_get_parent("+e[0]+")")}function handleZ_get_prop_len(t,e){return t._storer("_get_prop_len("+e[0]+")")}function handleZ_inc(t,e){var _="var incdec; ";return isNaN(e[0])?_+="var incdec; if ("+e[0]+" == 0) { incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] + 1) & 0xFFFF; } else if ("+e[0]+" < 0x10) { incdec = m_locals[( "+e[0]+" - 1 )] = (m_locals[( "+e[0]+" - 1 )] + 1) & 0xFFFF; } else { var val = getUnsignedWord(m_vars_start + ( "+e[0]+" - 16 ) * 2 ); val++; setWord(val, m_vars_start + ( "+e[0]+" - 16 ) * 2 ); incdec = val; }":0==e[0]?_+="incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] + 1) & 0xFFFF;":e[0]<0x10?_+="incdec = m_locals[( "+e[0]+" - 1 )] = (m_locals[( "+e[0]+" - 1 )] + 1) & 0xFFFF;":_+="{var val = getWord(m_vars_start + ( "+e[0]+" - 16 ) * 2 ); val++; setWord(val, m_vars_start + ( "+e[0]+" - 16 ) * 2 ); incdec = val;}",_}function handleZ_dec(t,e){var _="var incdec; ";return isNaN(e[0])?_+="if ("+e[0]+" == 0) { incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] - 1) & 0xFFFF; } else if ("+e[0]+" < 0x10) { incdec = m_locals[( "+e[0]+" - 1 )] = (m_locals[( "+e[0]+" - 1 )] - 1) & 0xFFFF; } else { var val = getUnsignedWord(m_vars_start + ( "+e[0]+" - 16 ) * 2 ); val--; setWord(val, m_vars_start + ( "+e[0]+" - 16 ) * 2 ); incdec = val; }":0==e[0]?_+="incdec = m_gamestack[m_gamestack.length - 1] = (m_gamestack[m_gamestack.length - 1] - 1) & 0xFFFF;":e[0]<0x10?_+="incdec = m_locals[( "+e[0]+" - 1 )] = (m_locals[( "+e[0]+" - 1 )] - 1) & 0xFFFF;":_+="{var val = getUnsignedWord(m_vars_start + ( "+e[0]+" - 16 ) * 2 ); val--; setWord(val, m_vars_start + ( "+e[0]+" - 16 ) * 2 ); incdec = val;}",_}function handleZ_print_addr(t,e){return t._handler_zOut('_zscii_from(_vm_report_string("addr", '+e[0]+"))",0)}function handleZ_remove_obj(t,e){return"_remove_obj("+e[0]+","+e[1]+")"}function handleZ_print_obj(t,e){return t._handler_zOut("_name_of_object("+e[0]+")",0)}function handleZ_ret(t,e){return t.m_compilation_running=0,"_func_return("+e[0]+");return"}function handleZ_jump(t,e){return t.m_compilation_running=0,0x8000&e[0]&&(e[0]=-65536|e[0]),"m_pc="+(e[0]+t.m_pc-2)+";return"}function handleZ_print_paddr(t,e){return t._handler_zOut("_zscii_from(_vm_report_string('paddr', "+t.m_pc_translate_for_string(e[0])+"))",0)}function handleZ_load(t,e){var _;return _=isNaN(e[0])?"("+e[0]+" == 0) ? m_gamestack[m_gamestack.length - 1] : ("+e[0]+" < 0x10) ? m_locals[( "+e[0]+" - 1 )] : getUnsignedWord( m_vars_start + ( "+e[0]+" - 16 ) * 2 )":0==e[0]?"m_gamestack[m_gamestack.length - 1]":e[0]<0x10?"m_locals[( "+e[0]+" - 1 )]":"getUnsignedWord( m_vars_start + ( "+e[0]+" - 16 ) * 2 )",t._storer(_)}function handleZ_rtrue(t,e){return t.m_compilation_running=0,"_func_return(1);return"}function handleZ_rfalse(t,e){return t.m_compilation_running=0,"_func_return(0);return"}function handleZ_print(t,e){return'_vm_report_string("inline",'+(t.m_pc-1)+");"+t._handler_print("",0)}function handleZ_print_ret(t,e){return t.m_compilation_running=0,'_vm_report_string("inlineret",'+(t.m_pc-1)+");"+t._handler_print("\n",1)+";_func_return(1);return"}function handleZ_nop(t,e){return""}function handleZ_restart(t,e){return t.m_compilation_running=0,"m_effects=["+GNUSTO_EFFECT_ERASEWINDOW+",0];resetStory();return"}function handleZ_ret_popped(t,e){return t.m_compilation_running=0,"_func_return(m_gamestack.pop());return"}function handleZ_catch(t,e){return t._storer("m_call_stack.length")}function handleZ_pop(t,e){return"m_gamestack.pop()"}function handleZ_quit(t,e){return t.m_compilation_running=0,"m_effects=["+GNUSTO_EFFECT_QUIT+"];return"}function handleZ_new_line(t,e){return t._handler_zOut("'\\n'",0)}function handleZ_show_status(t,e){return t._handler_zOut(""),""}function handleZ_verify(t,e){return t._brancher("_verify()")}function handleZ_illegal_extended(t,e){gnusto_error(199)}function handleZ_piracy(t,e){t.m_compilation_running=0;var _="m_rebound=function(){"+t._brancher("(!0)")+"};";return"m_pc="+t.m_pc+";"+_+"m_effects=["+GNUSTO_EFFECT_PIRACY+"];return"}function handleZ_call_1n(t,e){return t._generate_gosub(e[0],"",0)}function handleZ_call_1s(t,e){return t._generate_gosub(e[0],"",1)}function handleZ_call_2n(t,e){return t._generate_gosub(e[0],e[1],0)}function handleZ_call_2s(t,e){return t._generate_gosub(e[0],e[1],1)}function handleZ_call_vn(t,e){return t._generate_gosub(e[0],e.slice(1),0)}function handleZ_call_vs(t,e){return t._generate_gosub(e[0],e.slice(1),1)}function handleZ_store_w(t,e){if(isNotConst.test(e[0])||isNotConst.test(e[1]))var _="var tmp_"+ ++temp_var+" = ("+e[0]+" + 2 * "+e[1]+") & 0xFFFF;",r=(s="tmp_"+temp_var)+"+1";else{var s;_="",r=(s=e[0]+2*e[1]&0xFFFF)+1}if(isNotConst.test(e[2])){var n="tmp_"+ ++temp_var;return _+"var "+n+" = "+e[2]+";m_memory["+s+"] = ("+n+" >> 8) & 0xFF;m_memory["+r+"] = "+n+" & 0xFF;"}return t.m_value_asserts&&(null==e[2]||!0===e[2]||!1===e[2]||e[2]<0||e[2]>0xFFFF)&&t.logger("Z_store_w value",e[2]),_+"m_memory["+s+"] = "+(e[2]>>8&0xFF)+";m_memory["+r+"] = "+(0xFF&e[2])}function handleZ_storeb(t,e){return"setByte("+e[2]+",("+e[0]+"+"+e[1]+")&0xFFFF)"}function handleZ_putprop(t,e){return"_put_prop("+e[0]+","+e[1]+","+e[2]+")"}function handleZ_read(t,e){var _,r;t.m_compilation_running=0;var s,n,i="_aread(m_answers[0],m_rebound_args[1],m_rebound_args[2],m_answers[1])";t.m_version>=5&&(i=t._storer(i)),t.m_version>=5?(s="m_memory[0xFFFF&a0+1]",n="m_memory[0xFFFF&a0]"):(s="0",n="m_memory[0xFFFF&a0]+1"),e[2]&&e[3]&&t.m_version>=4?(_=e[2],r=t.m_pc_translate_for_routine(e[3])):(_="0",r="0");var a="m_rebound=function(){var t=1*m_answers[0];if(t<0){_func_interrupt(m_rebound_args[0],onISRReturn_for_read);}else{"+i+";}};",o="m_rebound_args=["+r+",a0,"+e[1]+",];";return"var a0=eval("+e[0]+");m_pc="+t.m_pc+";"+o+a+"m_effects=["+GNUSTO_EFFECT_INPUT+","+_+","+s+","+n+",_terminating_characters()];return"}function handleZ_print_char(t,e){return t._handler_zOut("_zscii_char_to_ascii("+e[0]+")",0)}function handleZ_print_num(t,e){return t._handler_zOut('""+_unsigned2signed('+e[0]+")",0)}function handleZ_random(t,e){return t._storer("_random_number("+e[0]+","+t.m_pc+")")}function handleZ_push(t,e){return"m_gamestack.push("+e[0]+")"}function handleZ_pull(t,e){return"var pull = m_gamestack.pop(); "+handleZ_store(t,[e[0],"pull"])}function handleZ_split_window(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SPLITWINDOW+","+e[0]+"];return"}function handleZ_set_window(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SETWINDOW+","+e[0]+"];return"}function handleZ_erase_window(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_ERASEWINDOW+","+t._unsigned2signed(e[0])+"];return"}function handleZ_erase_line(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_ERASELINE+","+e[0]+"];return"}function handleZ_set_cursor(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SETCURSOR+","+e[0]+","+e[1]+"];return"}function handleZ_get_cursor(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_GETCURSOR+","+e[0]+"];return"}function handleZ_set_text_style(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_STYLE+","+e[0]+",0,0];return"}function handleZ_buffer_mode(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SETBUFFERMODE+","+e[0]+"];return"}function handleZ_output_stream(t,e){return"_set_output_stream("+e[0]+","+e[1]+")"}function handleZ_input_stream(t,e){return t.m_compilation_running=0,"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SETINPUTSTREAM+","+e[0]+"];return"}function handleZ_sound_effect(t,e){for(t.m_compilation_running=0;e.length<5;)e.push(0);return"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_SOUND+","+e[0]+","+e[1]+","+e[2]+","+e[3]+","+e[4]+"];return"}function handleZ_read_char(t,e){var _,r,s;return t.m_compilation_running=0,e[1]&&e[2]&&t.m_version>=4?(_=e[1],r="m_rebound_args=["+t.m_pc_translate_for_routine(e[2])+"];",s="m_rebound=function(){var t=m_answers[0];if(t<0){_func_interrupt(m_rebound_args[0],onISRReturn_for_read_char);}else{"+t._storer("_ascii_code_to_zscii_code(t)")+"}};"):(_="0",r="",s="m_rebound=function(){"+t._storer("_ascii_code_to_zscii_code(m_answers[0])")+"};"),"m_pc="+t.m_pc+";"+r+s+"m_effects=["+GNUSTO_EFFECT_INPUT_CHAR+","+_+"];return"}function handleZ_scan_table(t,e){return 4==e.length?"t=_scan_table("+e[0]+","+e[1]+"&0xFFFF,"+e[2]+"&0xFFFF,"+e[3]+");"+t._storer("t")+";"+t._brancher("t"):"t=_scan_table("+e[0]+","+e[1]+"&0xFFFF,"+e[2]+"&0xFFFF,130);"+t._storer("t")+";"+t._brancher("t")}function handleZ_not(t,e){return t._storer("~"+e[0]+"&0xffff")}function handleZ_tokenise(t,e){return"_tokenise("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"}function handleZ_encode_text(t,e){return"_encode_text("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"}function handleZ_copy_table(t,e){return"_copy_table("+e[0]+","+e[1]+","+e[2]+")"}function handleZ_print_table(t,e){return e.length<3&&e.push(1),e.length<4&&e.push(0),"m_pc="+t.m_pc+";m_effects=_print_table("+e[0]+","+e[1]+","+e[2]+","+e[3]+");return"}function handleZ_check_arg_count(t,e){return t._brancher(e[0]+"<=_param_count()")}function handleZ_saveV123(t,e){t.m_compilation_running=0;var _="m_rebound=function(){"+t._brancher("m_answers[0]")+"};";return"m_pc="+t.m_pc+";m_state_to_save=_saveable_state(1);"+_+";m_effects=["+GNUSTO_EFFECT_SAVE+"];return"}function handleZ_saveV45678(t,e){t.m_compilation_running=0;var _="m_rebound=function() { "+t._storer("m_answers[0]")+"};";return"m_pc="+t.m_pc+";m_state_to_save=_saveable_state("+(4==t.m_version?"1":"3")+");"+_+";m_effects=["+GNUSTO_EFFECT_SAVE+"];return"}function handleZ_restoreV123(t,e){return t.m_compilation_running=0,t._brancher(""),"m_pc="+t.m_pc+";m_effects=["+GNUSTO_EFFECT_RESTORE+"];return"}function handleZ_restoreV45678(t,e){t.m_compilation_running=0;var _="m_rebound=function() { var t=m_answers[0]; if (t==0){"+t._storer("t")+"}};";return"m_pc="+t.m_pc+";"+_+"m_effects=["+GNUSTO_EFFECT_RESTORE+"];return"}function handleZ_log_shift(t,e){return t._storer("_log_shift("+e[0]+","+e[1]+")")}function handleZ_art_shift(t,e){return t._storer("_art_shift("+e[0]+","+e[1]+")")}function handleZ_set_font(t,e){return t._storer("("+e[0]+"<2?1:0)")}function handleZ_save_undo(t,e){return t._storer("_save_undo("+t.m_pc+")")}function handleZ_restore_undo(t,e){return"if(_restore_undo())return;"+t._storer("0")}function handleZ_print_unicode(t,e){return t._handler_zOut("String.fromCharCode("+e[0]+")",0)}function handleZ_check_unicode(t,e){return t._storer("3")}function handleZ_gestalt(t,e){return t._storer("gestalt("+e[0]+", "+(e.length<2?0:e[1])+")")}function handleZ_parchment(t,e){return t._storer("op_parchment("+e[0]+", "+(e.length<2?0:e[1])+")")}var handlers_v578={1:handleZ_je,2:handleZ_jl,3:handleZ_jg,4:handleZ_dec_chk,5:handleZ_inc_chk,6:handleZ_jin,7:handleZ_test,8:handleZ_or,9:handleZ_and,10:handleZ_test_attr,11:handleZ_set_attr,12:handleZ_clear_attr,13:handleZ_store,14:handleZ_insert_obj,15:handleZ_loadw,16:handleZ_loadb,17:handleZ_get_prop,18:handleZ_get_prop_addr,19:handleZ_get_next_prop,20:handleZ_add,21:handleZ_sub,22:handleZ_mul,23:handleZ_div,24:handleZ_mod,25:handleZ_call_2s,26:handleZ_call_2n,27:handleZ_set_colour,28:handleZ_throw,128:handleZ_jz,129:handleZ_get_sibling,130:handleZ_get_child,131:handleZ_get_parent,132:handleZ_get_prop_len,133:handleZ_inc,134:handleZ_dec,135:handleZ_print_addr,136:handleZ_call_1s,137:handleZ_remove_obj,138:handleZ_print_obj,139:handleZ_ret,140:handleZ_jump,141:handleZ_print_paddr,142:handleZ_load,143:handleZ_call_1n,176:handleZ_rtrue,177:handleZ_rfalse,178:handleZ_print,179:handleZ_print_ret,180:handleZ_nop,183:handleZ_restart,184:handleZ_ret_popped,185:handleZ_catch,186:handleZ_quit,187:handleZ_new_line,189:handleZ_verify,190:handleZ_illegal_extended,191:handleZ_piracy,224:handleZ_call_vs,225:handleZ_store_w,226:handleZ_storeb,227:handleZ_putprop,228:handleZ_read,229:handleZ_print_char,230:handleZ_print_num,231:handleZ_random,232:handleZ_push,233:handleZ_pull,234:handleZ_split_window,235:handleZ_set_window,236:handleZ_call_vs,237:handleZ_erase_window,238:handleZ_erase_line,239:handleZ_set_cursor,240:handleZ_get_cursor,241:handleZ_set_text_style,242:handleZ_buffer_mode,243:handleZ_output_stream,244:handleZ_input_stream,245:handleZ_sound_effect,246:handleZ_read_char,247:handleZ_scan_table,248:handleZ_not,249:handleZ_call_vn,250:handleZ_call_vn,251:handleZ_tokenise,252:handleZ_encode_text,253:handleZ_copy_table,254:handleZ_print_table,255:handleZ_check_arg_count,1000:handleZ_saveV45678,1001:handleZ_restoreV45678,1002:handleZ_log_shift,1003:handleZ_art_shift,1004:handleZ_set_font,1009:handleZ_save_undo,1010:handleZ_restore_undo,1011:handleZ_print_unicode,1012:handleZ_check_unicode,1030:handleZ_gestalt,1031:handleZ_parchment},handlers_fixups={1:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},2:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},3:{25:0,26:0,27:0,28:0,136:0,143:handleZ_not,181:handleZ_saveV123,182:handleZ_restoreV123,185:handleZ_pop,188:handleZ_show_status,190:0,191:0,236:0,237:0,238:0,239:0,240:0,241:0,242:0,246:0,247:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},4:{26:0,27:0,28:0,143:handleZ_not,181:handleZ_saveV45678,182:handleZ_restoreV45678,185:handleZ_pop,190:0,191:0,248:0,249:0,250:0,251:0,252:0,253:0,254:0,255:0},5:"",6:void 0,7:"",8:""};function pc_translate_v123(t){return"(("+t+")&0xFFFF)*2"}function pc_translate_v45(t){return"(("+t+")&0xFFFF)*4"}function pc_translate_v67R(t){return"(("+t+")&0xFFFF)*4+"+this.m_routine_start}function pc_translate_v67S(t){return"(("+t+")&0xFFFF)*4+"+this.m_string_start}function pc_translate_v8(t){return"(("+t+")&0xFFFF)*8"}function gnusto_error(t){message="Component: engine\n",message+="Code: "+t+"\n";for(var e=1;e<arguments.length;e++)arguments[e]&&arguments[e].toString&&(message+="\nDetail: "+arguments[e].toString());throw console.error(message),new Error(message)}function onISRReturn_for_read_char(t,e){e?(t.engine.m_answers[0]=0,t.rebound()):(t.engine.m_effects=t.effects,t.engine.m_rebound=t.rebound,t.engine.m_rebound_args=t.rebound_args)}function onISRReturn_for_read(t,e){var _=t.engine;e?(_.m_answers[0]=0,_.m_answers[1]="",t.rebound()):(_.m_effects=t.effects,_.m_rebound=t.rebound,_.m_rebound_args=t.rebound_args)}function GnustoEngine(t){this._classname="GnustoEngine",this.logger=t?function(e,_){t("gnusto-engine: "+e+": "+_)}:function(){},this.label_for_effect=label_for_effect}GnustoEngine.prototype={loadStory:function(t){this.m_memory=t,this._initial_setup()},loadSavedGame:function ge_loadSavedGame(savefile){var quetzal=new Quetzal(savefile),mem=quetzal.memory,stacks=quetzal.stacks,pc=quetzal.pc;function decodeStackInt(t,e){for(var _=stacks[t++],r=1;r<e;r++)_=_<<8|stacks[t++];return _}if(quetzal.compressed){for(var temp=[],cursor_compressed=0,cursor_original=0;cursor_compressed<mem.length;){cursor_original>=this.m_original_memory.length&&gnusto_error(999,"overshoot in decompression");var candidate=mem[cursor_compressed++];if(0==candidate){var run_length=mem[cursor_compressed++]+1,run=this.m_original_memory.slice(cursor_original,cursor_original+run_length);run.map(t=>temp.push(t)),cursor_original+=run_length}else temp.push(candidate^this.m_original_memory[cursor_original++])}mem=new Uint8Array(temp)}else mem=new Uint8Array(mem);var old_func_stack=this.m_func_stack;this.m_call_stack=[],this.m_func_stack=[],this.m_gamestack=[],this.m_locals_stack=[],this.m_locals=[],this.m_result_targets=[];var evals_count=0;evals_count=decodeStackInt(7,1),this.m_gamestack_callbreaks=[];for(var callbreaks_top=evals_count,cursor=8,m=0;m<evals_count;m++)this.m_gamestack.push(decodeStackInt(cursor,2)),cursor+=2;for(;cursor<stacks.length;){this.m_call_stack.push(decodeStackInt(cursor,3));var oldval=old_func_stack[this.m_func_stack.length];this.m_func_stack.push(oldval),this._vm_report_call(oldval,[]),cursor+=3;var flags=stacks[cursor++],varcode=stacks[cursor++];0x10&flags&&(varcode=-1);var locals_count=0xF&flags;this.m_locals_stack.unshift(locals_count),this.m_result_targets.push(varcode);for(var logArgs=stacks[cursor++]+1,argCount=0;logArgs>1;)logArgs>>=1,argCount++;this.m_param_counts.unshift(argCount),evals_count=decodeStackInt(cursor,2),cursor+=2,callbreaks_top+=evals_count,this.m_gamestack_callbreaks.push(callbreaks_top);for(var locals_temp=[],k=0;k<locals_count;k++)locals_temp.push(decodeStackInt(cursor,2)),cursor+=2;this.m_locals=locals_temp.concat(this.m_locals);for(var m=0;m<evals_count;m++)this.m_gamestack.push(decodeStackInt(cursor,2)),cursor+=2}for(var n=0;n<16;n++)this.m_locals.push(0);var newmem=this.m_memory.slice();newmem.set(mem,0),this.m_memory=newmem;var offset=1+(this.m_version<=4?1:3);this.m_pc=pc-offset,this.m_version<=3?eval("var t=new Function('with(this){'+this._brancher('1')+'}');t.call(this);"):this._varcode_set(2,this.m_memory[this.m_pc++])},resetStory:function(){this.m_memory=this.m_original_memory.slice(),this._initial_setup()},version:function(){gnusto_error(101,"'version' not implemented")},signature:function(){gnusto_error(101,"'signature' not implemented")},cvsVersion:function(){return CVS_VERSION.substring(7,26)},setGoldenTrail:function(t){this.m_goldenTrail=t?1:0},setCopperTrail:function(t){this.m_copperTrail=t?1:0},effect:function(t){return this.m_effects[t]},answer:function(t,e){this.m_answers[t]=e},run:function ge_run(){var start_pc=0,turns=0,jscode,turns_limit=this.m_single_step?1:10000;for(this.m_rebound&&(this.m_rebound(),this.m_rebound=0,this.m_rebound_args=[]),this.m_effects=[];0==this.m_effects.length;){if(turns++>=turns_limit)return this.m_effects=["WO"],1;start_pc=this.m_pc,this.m_jit[start_pc]?jscode=this.m_jit[start_pc]:(jscode=eval("with (this) {dummy="+this._compile()+"}"),start_pc>=this.m_stat_start&&(this.m_jit[start_pc]=jscode)),jscode()}},walk:function(t){gnusto_error(101,"'walk' not implemented")},setRandomSeed:function(t){t>0?this._random_number(-t):this._random_number(t)},saveGame:function(){function t(t,e){for(var _=[],r=0;r<e;r++)_[e-r-1]=0xFF&t,t>>=8;return _}var e=this.m_state_to_save,_=[],r=0,s=this.m_locals.length-16,n=0,i=[0x00,0x00,0x00,0x00,0x00,0x00],a=new Quetzal;a.release=e.m_memory.slice(0x02,0x04),a.serial=e.m_memory.slice(0x12,0x18),a.checksum=e.m_memory.slice(0x1C,0x1E),a.pc=e.m_pc,a.compressed=1;for(var o=0,m=this.m_stat_start;o<m;o++)e.m_memory[o]==this.m_original_memory[o]?256==++r&&(_.push(0),_.push(255),r=0):(0!=r&&(_.push(0),_.push(r-1),r=0),_.push(e.m_memory[o]^this.m_original_memory[o]));0!=r&&(_.push(0),_.push(r-1)),a.memory=_,i=i.concat(t(this.m_gamestack_callbreaks[0],2));for(var c=0;c<this.m_gamestack_callbreaks[0];c++)i=i.concat(t(this.m_gamestack[n++],2));for(var h=0;h<this.m_call_stack.length;h++){i=i.concat(t(this.m_call_stack[h],3));var l=this.m_locals_stack[this.m_locals_stack.length-(h+1)],u=l,d=this.m_result_targets[h],f=this.m_param_counts[this.m_param_counts.length-(h+1)],g=this.m_gamestack_callbreaks[h]-n;-1==d&&(d=0,u|=0x10),i=i.concat([u,d,(1<<f)-1,g>>8&0xFF,0xFF&g]),s-=l;for(var p=0;p<l;p++)i=i.concat(t(this.m_locals[s+p],2));for(c=0;c<g;c++)i=i.concat(t(this.m_gamestack[n++],2))}return a.stacks=i,this.m_quetzal_image=a.write(),this.m_quetzal_image.length},saveGameData:function(t,e){var _=this.m_quetzal_image;return this.m_quetzal_image=0,_},architecture:function(){return"none"},piracy:function(){return-1},tandy:function(){return-1},status:function(){return"this is the status, hurrah!"},getStatusLine:function(t){var e=this.getUnsignedWord(this.m_vars_start),_=this.getUnsignedWord(this.m_property_list_addr_start+this.m_object_size*e),r=this._zscii_from(_+1);if((r=" "+r).length>t){r=r.substring(0,t-3);var s="...",n=""}else{if(this.m_version>3&&!(2&~this.getByte(1))){var i=this.getUnsignedWord(this.m_vars_start+2),a=this.getUnsignedWord(this.m_vars_start+4);if(a<10)s=i+":0"+a;else s=i+":"+a}else s="Score: "+this.getWord(this.m_vars_start+2)+"  Moves: "+this.getWord(this.m_vars_start+4)+" ";r.length+s.length+1>t&&(s=" "+this.getUnsignedWord(this.m_vars_start+2)+"/"+this.getUnsignedWord(this.m_vars_start+4)+" ",r.length+s.length+1>t&&(s=""));for(n="";r.length+s.length+n.length<t;)n+=" "}return r+n+s},gestalt:function(t,e){return 1==t?0x0102:0x20==t&&(0==e||1==e&&PARCHMENT_SECURITY_OVERRIDE)?1:0},op_parchment:function(id,arg){var self=this;return 1==id&&PARCHMENT_SECURITY_OVERRIDE?(1==arg?(self.op_parchment_data.saved_buffer=self.m_console_buffer,self.m_console_buffer="",self.op_parchment_data.raw_eval=1):(self.op_parchment_data.raw_eval&&(eval(self.m_console_buffer),self.m_console_buffer=self.op_parchment_data.saved_buffer),self.op_parchment_data.raw_eval=0),1):0},m_report_info:null,m_report_accum:null,m_report_counter:0,m_last_report:null,prepare_vm_report:function(t){m_report_info=t,m_report_counter=0},reset_vm_report:function(){for(var t of(m_last_report=null,m_report_accum={strings:[],calls:[]},this.m_func_stack))m_report_accum.calls.push({t:"c",addr:t,args:[]})},_vm_report_string:(t,e)=>(m_report_accum&&(m_report_accum.strings.push(e),m_report_accum.calls.push({t:"s",addr:e})),e),_vm_report_call:(t,e)=>(m_report_accum&&m_report_accum.calls.push({t:"c",addr:t,args:[...e]}),t),_vm_report_return(){m_report_accum&&m_report_accum.calls.push({t:"r"})},get_vm_report:function(t){if(!m_report_info||!m_report_accum)return null;if(m_last_report)return m_last_report;for(var e={counter:m_report_counter,globtableaddr:this.m_vars_start,objtableaddr:this.m_objs_start,proptable:this.m_memory.slice(m_report_info.PROP_TABLE_START,m_report_info.PROP_TABLE_END),strings:m_report_accum.strings,specifics:void 0,objects:[]},_=1;_<=m_report_info.MAX_OBJECTS;){var r=this.m_object_tree_start+_*this.m_object_size,s=0x1000000*this.m_memory[r+0]+0x10000*this.m_memory[r+1]+0x100*this.m_memory[r+2]+this.m_memory[r+3];e.objects.push({onum:_,parent:this._get_parent(_),child:this._get_child(_),sibling:this._get_sibling(_),attrs:s}),_++}e.globals=[];for(var n=0;n<m_report_info.MAX_GLOBALS;){var i=this.getUnsignedWord(this.m_vars_start+2*n);e.globals.push(i),n++}var a=e.globals[m_report_info.C_TABLE_GLOB];e.timertable=this.m_memory.slice(a,a+m_report_info.C_TABLE_LEN);var o={type:"call",addr:this.getUnsignedWord(0x6)-1,args:[],children:[]},m=[o];for(var c of m_report_accum.calls)if("c"==c.t){var h={type:"call",addr:c.addr,args:c.args,children:[]};m[m.length-1].children.push(h),m.push(h)}else if("s"==c.t){var l={type:"print",addr:c.addr};if(m[m.length-1].children.push(l),!m[m.length-1].hasprint)for(var u=m.length-1;u>=0&&!m[u].hasprint;)m[u].hasprint=!0,u--}else"r"==c.t&&m.pop();return e.calltree=o,t&&(e.specifics=t(this,e)),m_report_counter++,m_last_report=e,e},_initial_setup:function(){this.m_jit=[],this.m_compilation_running=0,this.m_gamestack=[],this.m_gamestack_callbreaks=[],this.m_call_stack=[],this.m_func_stack=[],this.m_locals=[],this.m_locals_stack=[],this.m_param_counts=[],this.m_result_targets=[],this.m_goldenTrail=0,this.m_copperTrail=0,this.m_version=this.m_memory[0],this.m_original_memory=this.m_memory.slice(),this.m_himem=this.getUnsignedWord(0x4),this.m_pc=this.getUnsignedWord(0x6),this.m_dict_start=this.getUnsignedWord(0x8),this.m_objs_start=this.getUnsignedWord(0xA),this.m_vars_start=this.getUnsignedWord(0xC),this.m_stat_start=this.getUnsignedWord(0xE),this.m_abbr_start=this.getUnsignedWord(0x18),this.m_version>=4?(this.m_alpha_start=this.getUnsignedWord(0x34),this.m_object_tree_start=this.m_objs_start+112,this.m_property_list_addr_start=this.m_object_tree_start+12,this.m_object_size=14):(this.m_alpha_start=0,this.m_object_tree_start=this.m_objs_start+53,this.m_property_list_addr_start=this.m_object_tree_start+7,this.m_object_size=9),this.m_hext_start=this.getUnsignedWord(0x36),this.m_version<=3?(this.m_pc_translate_for_routine=pc_translate_v123,this.m_pc_translate_for_string=pc_translate_v123):this.m_version<=5?(this.m_pc_translate_for_routine=pc_translate_v45,this.m_pc_translate_for_string=pc_translate_v45):this.m_version<=7?(this.m_routine_start=8*this.getUnsignedWord(0x28),this.m_string_start=8*this.getUnsignedWord(0x2a),this.m_pc_translate_for_routine=pc_translate_v67R,this.m_pc_translate_for_string=pc_translate_v67S):8==this.m_version?(this.m_pc_translate_for_routine=pc_translate_v8,this.m_pc_translate_for_string=pc_translate_v8):gnusto_error(170,"impossible: unknown z-version got this far"),this.m_version in handlers_fixups||gnusto_error(311,"unknown z-machine version");var t,e,_=handlers_fixups[this.m_version];switch(typeof _){case"undefined":gnusto_error(101,"z-machine version not implemented");break;case"string":this.m_handlers=handlers_v578;break;case"object":for(var r in this.m_handlers={},handlers_v578)this.m_handlers[r]=handlers_v578[r];for(var s in _)"function"==typeof _[s]?this.m_handlers[s]=_[s]:delete this.m_handlers[s];break;default:gnusto_error(170,"impossible: weird stuff in fixups table")}this.m_separator_count=this.m_memory[this.m_dict_start];for(var n=0;n<this.m_separator_count;n++)this.m_separators[n]=this._zscii_char_to_ascii(this.m_memory[this.m_dict_start+n+1]);if(this.m_hext_start>0&&(this.m_unicode_start=this.getUnsignedWord(this.m_hext_start+6),this.m_unicode_start>0)){this.m_custom_unicode_charcount=this.m_memory[this.m_unicode_start],this.m_unicode_start+=1;for(n=0;n<this.m_custom_unicode_charcount;n++)reverse_unicode_table[this.getUnsignedWord(this.m_unicode_start+2*n)]=n+155}if(!(this.m_unicode_start>0))for(var n in default_unicode_translation_table)reverse_unicode_table[default_unicode_translation_table[n]]=n;if(this.m_rebound=0,this.m_rebound_args=[],this.m_output_to_console=1,this.m_streamthrees=[],this.m_output_to_script=0,this.m_console_buffer="",this.m_transcript_buffer="",this.m_zalphabet[0]="abcdefghijklmnopqrstuvwxyz",this.m_zalphabet[1]="ABCDEFGHIJKLMNOPQRSTUVWXYZ",1==this.m_version?this.m_zalphabet[2]="T0123456789.,!?_#'\"/\\<-:()":this.m_zalphabet[2]="T\n0123456789.,!?_#'\"/\\-:()",this.m_alpha_start>0)for(var i=0;i<3;i++){for(var a="",o=0;o<26;o++)(e=this.m_memory[this.m_alpha_start+26*i+o])>=155&&e<=251?0==this.m_unicode_start?a+=String.fromCharCode(default_unicode_translation_table[e]):e-154<=this.m_custom_unicode_charcount?a+=String.fromCharCode(this.getUnsignedWord(this.m_unicode_start+2*(e-155))):a+=" ":("^"==(t=String.fromCharCode(e))&&(t="\n"),a+=t);this.m_zalphabet[i]=a}for(n=0;n<16;n++)this.m_locals[n]=0;this.m_printing_header_bits=0,this.m_leftovers="",this.m_version>=4&&(this.m_memory[0x1E]=1,this.m_memory[0x1F]=0),this.m_version>=4&&(this.m_memory[1]|=0x1D,this.m_memory[0x26]=1,this.m_memory[0x27]=1),this.m_memory[0x32]=1,this.m_memory[0x33]=PARCHMENT_SECURITY_OVERRIDE?2:0},_unsigned2signed:function(t){return(0x8000&t?-65536:0)|t},_signed2unsigned:function(t){return 0xFFFF&t},getByte:function(t){if(this.m_value_asserts){(null==t||!0===t||!1===t||t<0||t>=this.m_original_memory.length)&&this.logger("getByte addr",t);var e=this.m_memory[t];(null==e||!0===e||!1===e||e<0||e>0xFF)&&this.logger("getByte byte",e)}return this.m_memory[t]},setByte:function(t,e){this.m_value_asserts&&(null==e||!0===e||!1===e||e<0||e>=this.m_stat_start)&&this.logger("setByte addr",e),this.m_memory[e]=0xFF&t},getWord:function(t){var e;this.m_value_asserts&&((null==t||!0===t||!1===t||t<0||t>=this.m_original_memory.length)&&this.logger("getWord addr",t),(null==(e=this.m_memory[t])||!0===e||!1===e||e<0||e>0xFF)&&this.logger("getWord high byte",e),(null==(e=this.m_memory[t+1])||!0===e||!1===e||e<0||e>0xFF)&&this.logger("getWord low byte",e));var _=this.m_memory[t]<<8|this.m_memory[t+1];return(0x8000&_?-65536:0)|_},getUnsignedWord:function(t){var e;this.m_value_asserts&&((null==t||!0===t||!1===t||t<0||t>=this.m_original_memory.length)&&this.logger("getUnsignedWord addr",t),(null==(e=this.m_memory[t])||!0===e||!1===e||e<0||e>0xFF)&&this.logger("getUnsignedWord high byte",e),(null==(e=this.m_memory[t+1])||!0===e||!1===e||e<0||e>0xFF)&&this.logger("getUnsignedWord low byte",e));return this.m_memory[t]<<8|this.m_memory[t+1]},setWord:function(t,e){this.m_value_asserts&&(null==e||!0===e||!1===e||e<0||e>=this.m_stat_start)&&this.logger("setWord",e),this.m_memory[e]=t>>8&0xFF,this.m_memory[e+1]=0xFF&t},_handle_variable_parameters:function(t,e,_){var r,s=0,n="";for(1==_&&(e=e<<8|0xFF);;){var i=0xC000&e;if(0xC000==i)return n;0x0000==i?(t[s++]=this.getUnsignedWord(this.m_pc),this.m_pc+=2):0x4000==i?t[s++]=this.m_memory[this.m_pc++]:0x8000==i&&(n+=(r=this._code_for_varcode(this.m_memory[this.m_pc++]))[0],t[s++]=r[1]),e=e<<2|0x3}},_compile:function(){this.m_compilation_running=1;var t,e,_="",r=this.m_pc;temp_var=0;do{var s=[],n=this.m_pc;(null==n||n<0||n>=this.m_original_memory.length)&&gnusto_error(206,n);var i=this.m_memory[this.m_pc++];if(0==i)gnusto_error(201);else if(190==i)i=1000+this.m_memory[this.m_pc++],_+=this._handle_variable_parameters(s,this.m_memory[this.m_pc++],1);else if(0x80&i)if(0x40&i)if(0x20&i||(i&=0x1F),250==i||236==i){var a=this.getUnsignedWord(this.m_pc);this.m_pc+=2,_+=this._handle_variable_parameters(s,a,2)}else _+=this._handle_variable_parameters(s,this.m_memory[this.m_pc++],1);else switch(0x30&i){case 0x00:s[0]=this.getUnsignedWord(this.m_pc),this.m_pc+=2,i=0x0F&i|0x80;break;case 0x10:s[0]=this.m_memory[this.m_pc++],i=0x0F&i|0x80;break;case 0x20:_+=(t=this._code_for_varcode(this.m_memory[this.m_pc++]))[0],s[0]=t[1],i=0x0F&i|0x80;break;case 0x30:i=0x0F&i|0xB0}else 0x40&i?(_+=(t=this._code_for_varcode(this.m_memory[this.m_pc++]))[0],s[0]=t[1]):s[0]=this.m_memory[this.m_pc++],0x20&i?(_+=(t=this._code_for_varcode(this.m_memory[this.m_pc++]))[0],s[1]=t[1]):s[1]=this.m_memory[this.m_pc++],i&=0x1F;this.m_handlers[i]?_=_+this.m_handlers[i](this,s)+";":i>=1128&&i<=1255&&"special_instruction_EXT"+(i-1000)in this?_=_+this["special_instruction_EXT"+(i-1000)](s)+";":gnusto_error(200,this.m_pc.toString(16))}while(this.m_compilation_running);(this.m_single_step||this.m_debug_mode)&&(_=_+"m_pc="+this.m_pc),_=_.replace(/m_gamestack\.push\(([^;]+)\);var tmp_(\d+) = m_gamestack\.pop\(\);/,"var tmp_$2 = $1;"),e="function JIT_"+r.toString(16)+"_"+r;return(e+=window.vm_functions?"_"+function(t){for(;!vm_functions[t]&&t>0;)t--;return vm_functions[t]}(r):"")+"(){"+_+"}"},_param_count:function(){return this.m_param_counts[0]},_set_output_stream:function(t,e){if(0==(t=this._unsigned2signed(t)));else if(1==t)this.m_output_to_console=1;else if(2==t)this.m_memory[0x11]|=0x1;else if(3==t)this.m_streamthrees.length>15&&gnusto_error(202),this.m_streamthrees.unshift([e,e+2]);else if(4==t)this.m_output_to_script=1;else if(-1==t)this.m_output_to_console=0;else if(-2==t)this.m_memory[0x11]&=-2;else if(-3==t){this.m_streamthrees.length<1&&gnusto_error(203);var _=this.m_streamthrees.shift();this.setWord(_[1]-_[0]-2,_[0])}else-4==t?this.m_output_to_script=0:gnusto_error(204,t)},_trunc_divide:function(t,e){var _;return t=this._unsigned2signed(t),0==(e=this._unsigned2signed(e))?(gnusto_error(701),0):(_=t/e)>0?0xFFFF&Math.floor(_):0xFFFF&Math.ceil(_)},_trunc_modulo:function(t,e){return t=this._unsigned2signed(t),0==(e=this._unsigned2signed(e))?(gnusto_error(701),0):t%e&0xFFFF},_zscii_char_to_ascii:function(t){var e;if(t<0&&gnusto_error(702,t),0==t)return"";if(10==t||13==t)return"\n";if(t>=32&&t<=126||0==t)e=t;else{if(!(t>=155&&t<=251))return"*";if(0==this.m_unicode_start)return String.fromCharCode(default_unicode_translation_table[t]);if(t-154<=this.m_custom_unicode_charcount)return String.fromCharCode(this.getUnsignedWord(this.m_unicode_start+2*(t-155)));gnusto_error(703,t)}return String.fromCharCode(e)},_ascii_code_to_zscii_code:function(t){var e={10:13,13:13,37:131,38:129,39:132,40:130};if(isNaN(t)){if(t.keyCode&&e[t.keyCode])return e[t.keyCode];t=t.charCode}if(10==t||13==t)return 13;if(t>31&&t<127||0==t)return t;t<0&&gnusto_error(702,"Illegal unicode character:"+t);var _=reverse_unicode_table[t];return _||(_=42),_},m_random_rigged_rolls:{},rig_vm_random:function(t,e){let _=this.m_random_rigged_rolls[t];void 0===_&&(_=[],this.m_random_rigged_rolls[t]=_),_.push(e)},_random_number:function(t,e){if(t=this._unsigned2signed(t),e&&this.m_random_rigged_rolls[e]){let _=this.m_random_rigged_rolls[e];if(_.length){let r=_.shift();return _.length||(this.m_random_rigged_rolls[e]=void 0),console.log("forcing @random at",e,"to",r),(t<=0||r>t)&&console.log("BUG: forced value appears invalid",t,r),r}}if(0==t)return this.m_random_use_seed=this.m_random_use_sequence=0,0;if(t<-999)return this.m_random_state=Math.abs(t),this.m_random_use_seed=1,this.m_random_use_sequence=0,0;if(t<0)return this.m_random_sequence_max=Math.abs(t)-1,this.m_random_state=0,this.m_random_use_seed=0,this.m_random_use_sequence=1,0;if(this.m_random_use_seed)return this.m_random_state--,1+Math.round(8.71*Math.abs(Math.tan(this.m_random_state))*t)%t;if(this.m_random_use_sequence){var _=this.m_random_state;return this.m_random_state=this.m_random_state+1,this.m_random_state>this.m_random_sequence_max&&(this.m_random_state=0),1+_%t}return 1+Math.round((t-1)*Math.random())},_func_gosub:function(t,e,_,r){this.m_call_stack.push(_),this.m_func_stack.push(t),this._vm_report_call(t,e),this.m_pc=t;var s=this.m_memory[this.m_pc++];if(this.m_version<5){for(var n=[],i=0;i<s;i++)i<e.length?n.push(e[i]):n.push(this.getUnsignedWord(this.m_pc)),this.m_pc+=2;this.m_locals=n.concat(this.m_locals)}else for(var a=s;a>0;a--)a<=e.length?this.m_locals.unshift(e[a-1]):this.m_locals.unshift(0);this.m_locals_stack.unshift(s),this.m_param_counts.unshift(e.length),this.m_result_targets.push(r),this.m_gamestack_callbreaks.push(this.m_gamestack.length),0==t&&this._func_return(0)},_func_interrupt:function(t,e){this.m_interrupt_information.push({on_return:e,rebound:this.m_rebound,rebound_args:this.m_rebound_args,engine:this,pc:this.m_pc,effects:this.m_effects}),this._func_gosub(t,[],CALLED_FROM_INTERRUPT,-1)},_tokenise:function(t,e,_,r){var s=0,n=e+2,i=e+1;function a(t,e,_,i){var a=function(t,e,_){function r(t,e,_){for(var r,s,n=0;;){if(n==e.length)return 0;if((r=t.m_memory[_+n])!=(s=e.charCodeAt(n)))return r<s?-1:1;n++}}var s=t.m_memory[_+t.m_separator_count+1],n=t.getWord(_+t.m_separator_count+2),i=t.m_dict_start+t.m_separator_count+4,a=1;if(n<0&&(a=0,n=-n),e=t._into_zscii(e),a)for(var o,m,c,h=0,l=n-1;;){if((c=r(t,e,m=i+(o=h+Math.round((l-h)/2))*s))<0){if(h==l)return 0;h=o+1}else{if(!(c>0))return m;if(h==l)return 0;l=o-1}if(h>l)return 0}else for(var u=0;u<n;u++){var d=i+u*s;if(0==r(t,e,d))return d}return 0}(t,_,e);return r&&0==a?n+=4:(t.setWord(a,n),n+=2,t.setByte(_.length,n++),t.setByte(i,n++)),s++,1}isNaN(_)&&(_=0),isNaN(r)&&(r=0);this.m_memory[t];var o="";if(0==_&&(_=this.m_dict_start),this.m_version<=4){0;for(var m=t+1;;){var c=this.m_memory[m++];if(0==c)break;o+=String.fromCharCode(c)}}else for(var h=0;h<this.m_memory[t+1];h++)o+=String.fromCharCode(this.m_memory[t+2+h]);var l,u=[],d="",f=0;l=this.m_version<=4?1:2;for(var g=0;g<o.length;g++)" "==o.charAt(g)?""!=d&&(u[f]=d,a(this,_,u[f],g-u[f].length+l),f++,d=""):this._is_separator(o.charAt(g))?(""!=d&&(u[f]=d,a(this,_,u[f],g-u[f].length+l),f++),u[f]=o.charAt(g),a(this,_,u[f],g+l),f++,d=""):d+=o.charAt(g);""!=d&&(u[f]=d,a(this,_,u[f],g-u[f].length+l)),this.setByte(s,i)},_aread:function(t,e,_,r){var s,n,i;e&=0xFFFF,_&=0xFFFF,this.m_version<=4?(s=this.m_memory[e]+1,n=r.substring(0,s).toLowerCase(),i=e+1,this.setByte(0,e+1+n.length)):(s=this.m_memory[e],n=r.substring(0,s).toLowerCase(),i=e+2,this.setByte(n.length,e+1));for(var a=0;a<n.length;a++)this.setByte(this._ascii_code_to_zscii_code(n.charCodeAt(a)),i+a);return(0!=_||this.m_version<5)&&this._tokenise(e,_,0,0),13==t?10:t},_terminating_characters:function(){if(this.m_version<5)return"\r";for(var t=this.getUnsignedWord(0x2e),e="\r";;){var _=this.m_memory[t++];if(0==_)break;(_>=129&&_<=154||_>=252)&&(e+=String.fromCharCode(_))}return e},_func_return:function(t){this.m_locals=this.m_locals.slice(this.m_locals_stack.shift()),this.m_param_counts.shift(),this.m_pc=this.m_call_stack.pop(),this.m_func_stack.pop(),this._vm_report_return(),this.m_gamestack.length=this.m_gamestack_callbreaks.pop();var e=this.m_result_targets.pop();if(-1!=e&&null!=t&&(0==e?this.m_gamestack.push(t):e<0x10?this.m_locals[e-1]=t:this.setWord(t,this.m_vars_start+2*(e-16))),this.m_pc==CALLED_FROM_INTERRUPT){var _=this.m_interrupt_information.pop();this.m_pc=_.pc,_.on_return(_,t)}},_throw_stack_frame:function(t){for((t>this.m_call_stack.length||t<1)&&gnusto_error(207,t);this.m_call_stack.length>t-1;)this._func_return(null)},_get_prop_addr:function(t,e){if(0==t)return 0;var _=this._property_search(t,e,-1);return _[2]?_[0]:0},_get_prop_len:function(t){if((null==t||!0===t||!1===t||t<0||t>=this.m_stat_start)&&this.logger("get_prop_len",t),0==t)return 0;if(this.m_version<4)return 1+(this.m_memory[t-1]>>5);var e=this.m_memory[t-1];return 0x80&e?0==(e&=0x3F)?64:e:0x40&e?2:1},_get_next_prop:function(t,e){if(0==t)return 0;var _=this._property_search(t,-1,e);return _[2]?_[3]:_[4]?0:(gnusto_error(205,e),void gnusto_error(173))},_get_prop:function(t,e){if(0==t)return 0;var _=this._property_search(t,e,-1);return this.m_value_asserts&&(null==_[0]||!0===_[0]||!1===_[0]||_[0]<0||_[0]>=this.m_stat_start)&&this.logger("get_prop",_[0]),1==_[1]?this.m_memory[_[0]]:2==_[1]?this.m_memory[_[0]]<<8|this.m_memory[_[0]+1]:this.getUnsignedWord(_[0])},_property_search:function(t,e,_){var r=this.getUnsignedWord(this.m_property_list_addr_start+t*this.m_object_size);r=r+2*this.m_memory[r]+1;for(var s=0;;){var n=1,i=this.m_memory[r++];if(this.m_version<4?(n=1+(i>>5),i&=0x1F):(0x80&i?0==(n=0x3F&this.m_memory[r++])&&(n=64):0x40&i&&(n=2),i&=0x3F),i==e||s==_)return[r,n,1,i,0];if(i<e)return e>0?[this.m_objs_start+2*(e-1),2,0,e,0]:[-1,-1,0,e,s==e];r+=n,s=i}gnusto_error(175)},_set_attr:function(t,e){if(0!=t){var _=this.m_object_tree_start+t*this.m_object_size+(e>>3),r=this.m_memory[_];this.setByte(r|128>>e%8,_)}},_clear_attr:function(t,e){if(0!=t){var _=this.m_object_tree_start+t*this.m_object_size+(e>>3),r=this.m_memory[_];this.setByte(r&~(128>>e%8),_)}},_test_attr:function(t,e){return 0==t?0:this.m_memory[this.m_object_tree_start+t*this.m_object_size+(e>>3)]&128>>e%8?1:0},_put_prop:function(t,e,_){if(0!=t){var r=this._property_search(t,e,-1);r[2]||gnusto_error(704),1==r[1]?this.setByte(_,r[0]):2==r[1]?this.setWord(_,r[0]):gnusto_error(705)}},_get_older_sibling:function(t){if(0==t)return 0;var e=this._get_child(this._get_parent(t));if(t==e)return 0;for(;e;){var _=this._get_sibling(e);if(_==t)return e;e=_}return 0},_insert_obj:function(t,e){var _=this._get_parent(t),r=this._get_older_sibling(t),s=this._get_sibling(t);_&&this._get_child(_)==t&&this._set_child(_,s),r&&this._set_sibling(r,s),this._set_parent(t,e),e&&(this._set_sibling(t,this._get_child(e)),this._set_child(e,t))},_remove_obj:function(t,e){this._insert_obj(t,0)},_get_family:function(t,e){return 0==t?0:this.m_version<4?this.m_memory[this.m_object_tree_start+4+e+t*this.m_object_size]:this.getUnsignedWord(this.m_object_tree_start+6+2*e+t*this.m_object_size)},_get_parent:function(t){return this._get_family(t,PARENT_REC)},_get_child:function(t){return this._get_family(t,CHILD_REC)},_get_sibling:function(t){return this._get_family(t,SIBLING_REC)},_set_family:function(t,e,_){this.m_version<4?this.setByte(e,this.m_object_tree_start+4+_+t*this.m_object_size):this.setWord(e,this.m_object_tree_start+6+2*_+t*this.m_object_size)},_set_parent:function(t,e){this._set_family(t,e,PARENT_REC)},_set_child:function(t,e){this._set_family(t,e,CHILD_REC)},_set_sibling:function(t,e){this._set_family(t,e,SIBLING_REC)},_obj_in:function(t,e){return this._get_parent(t)==e},_copy_table:function(t,e,_){if(_=this._unsigned2signed(_),0==e)for(var r=0;r<_;r++)this.setByte(0,r+t);else{var s=0;if(_<0?(_=-_,s=1):s=t>e?1:0,s)for(r=0;r<_;r++)this.setByte(this.m_memory[t+r],e+r);else for(r=_-1;r>=0;r--)this.setByte(this.m_memory[t+r],e+r)}},_scan_table:function(t,e,_,r){var s=0x7F&r,n=e+_*s;if(!(0x80&~r))for(;e<n;){if((0xFF&this.m_memory[0xFFFF&e])==(t>>8&0xFF)&&(0xFF&this.m_memory[0xFFFF&e+1])==(0xFF&t))return e;e+=s}else for(;e<n;){if((0xFF&this.m_memory[0xFFFF&e])==(0xFFFF&t))return e;e+=s}return 0},_print_table:function(t,e,_,r){for(var s=[],n=0;n<_;n++){for(var i="",a=0;a<e;a++)t<0&&(t&=0xFFFF),i+=this._zscii_char_to_ascii(this.m_memory[t++]);s.push(i),t+=r}var o=["PT",s.length];return o=o.concat(s)},_zscii_from:function(t,e,_){if(t in this.m_jit)return _?this.m_jit[t]:this.m_jit[t][0];var r="",s=1,n=t,i=0,a=i,o=-2,m=0;e||(e=65535);for(var c=t+e;s;){var h=this.getUnsignedWord(t);t+=2,s=!(0x8000&h)&&t<c;for(var l=2;l>=0;l--){var u=h>>5*l&0x1f;m?(r+=this._zscii_from(2*this.getUnsignedWord(2*(32*(m-1)+u)+this.m_abbr_start)),m=0,a=i):-2==o?u>5?2==a&&6==u?o=-1:(r+=this.m_zalphabet[a].charAt(u-6),a=i):0==u?(r+=" ",a=i):u<4?this.getByte(0)>2?m=u:2==u?(a+=1)>2&&(a=0):3==u?(a-=1)<0&&(a=2):2==this.getByte(0)?m=1:(r+="\n",a=i):this.getByte(0)>2?a=u-3:(4==u?(i+=1)>2&&(i=0):(i-=1)<0&&(i=2),a=i):-1==o?o=u:(r+=this._zscii_char_to_ascii((o<<5)+u),o=-2,a=i)}}return n>=this.m_stat_start&&(this.m_jit[n]=[r,t]),_?[r,t]:r},_encode_text:function(t,e,_,r){t=t+_&0xFFFF;for(var s="";e>0;){var n=this.m_memory[t];if(0==n)break;s+=String.fromCharCode(n),t++,e--}for(var i=this._into_zscii(s),a=0;a<i.length;a++){var o=i[a].charCodeAt(0);this.setByte(o,r++)}},_into_zscii:function(t){var e,_="",r=[];function s(t){if(r.push(t),3==r.length){var s=r[0]<<10|r[1]<<5|r[2];_.length==e-2&&(s|=0x8000),_=_+String.fromCharCode(s>>8)+String.fromCharCode(0xFF&s),r=[]}}e=this.m_version<4?4:6;for(var n,i,a=0;a<t.length&&_.length<e;){if((n=t.charCodeAt(a++))>=65&&n<=90)n+=32;else if(n>154)if(0==this.m_unicode_start)n>=158&&n<=160||n>=167&&n<=168||n>=208&&n<=210?n-=3:n>=175&&n<=180?n-=6:n>=186&&n<=190||n>=196&&n<=200?n-=5:217==n||218==n?n-=2:202!=n&&204!=n&&212!=n&&214!=n&&221!=n||(n-=1);else{var o=this._ascii_code_to_zscii_code(this._zscii_char_to_ascii(n).toLowerCase().charCodeAt(0));o>0&&o<=251&&o!="*".charCodeAt(0)&&(n=o)}var m=String.fromCharCode(this._zscii_char_to_ascii(n).charCodeAt(0));-1!=(i=this.m_zalphabet[0].indexOf(m))?s(i+6):-1!=(i=this.m_zalphabet[1].indexOf(m))?(this.getByte(0)>2?s(4):s(2),s(i+6)):-1!=(i=this.m_zalphabet[2].indexOf(m))?(this.getByte(0)>2?s(5):s(3),s(i+6)):(this.getByte(0)>2?s(5):s(3),s(6),s(n>>5),s(0x1F&n))}for(;_.length<e;)s(5);return _.substring(0,e)},_name_of_object:function(t){if(0==t)return"<void>";var e=this.m_property_list_addr_start+t*this.m_object_size,_=this.getUnsignedWord(e)+1;return this._vm_report_string("obj",_),this._zscii_from(_)},_print_leftovers:function(){this._zOut(this.m_leftovers),this.m_leftovers=""},_zOut:function(t){if(this.m_streamthrees.length){this.m_streamthrees[0];for(var e=this.m_streamthrees[0][1],_=0;_<t.length;_++)this.setByte(this._ascii_code_to_zscii_code(t.charCodeAt(_)),e++);this.m_streamthrees[0][1]=e}else{var r=0x03&this.m_memory[0x11],s=r!=this.m_printing_header_bits;if(this.m_printing_header_bits=r,s)return this.m_leftovers=t,this.m_rebound=this._print_leftovers,1;this.m_output_to_console&&(this.m_console_buffer=this.m_console_buffer+t),1&r&&(this.m_transcript_buffer=this.m_transcript_buffer+t)}return 0},consoleText:function(){var t=this,e=t.m_console_buffer.replace("\0","","g");return t.op_parchment_data.raw_eval?"":(t.m_console_buffer="",e)},_transcript_text:function(){var t=this.m_transcript_buffer.replace("\0","","g");return this.m_transcript_buffer="",t},_is_separator:function(t){for(var e=0;e<this.m_separator_count;e++)if(t==this.m_separators[e])return 1;return 0},_code_for_varcode:function(t){var e,_="";if(0==t)_="var tmp_"+ ++temp_var+" = m_gamestack.pop();",e="tmp_"+temp_var;else if(t<0x10)e="m_locals["+(t-1)+"]";else{var r=this.m_vars_start+2*(t-16),s="tmp_"+ ++temp_var;_="var "+s+" = (m_memory["+r+"] << 8) | m_memory["+(r+1)+"];",e=s}return[_,e]},_varcode_set:function(t,e){0==e?this.m_gamestack.push(t):e<0x10?this.m_locals[e-1]=t:this.setWord(t,this.m_vars_start+2*(e-16))},_brancher:function(t){var e=1,_=this.m_memory[this.m_pc++],r=0x3F&_;0x80&_&&(e=0),0x40&_||0x2000&(r=r<<8|this.m_memory[this.m_pc++])&&(r=-8192|0x1FFF&r);var s=t;return s=e?"if(!("+s+"))":"if("+s+")",0==r?s+"{_func_return(0);return;}":1==r?s+"{_func_return(1);return;}":s+"{m_pc="+(r=this.m_pc+r-2)+";return;}"},_storer:function(t){var e=this.m_memory[this.m_pc++];return t.substring&&"_func_gosub"==t.substring(0,11)?(this.m_compilation_running=0,",-1)"!=t.substring(t.length-4)&&gnusto_error(100,t),t.substring(0,t.length-3)+e+")"):0==e?"m_gamestack.push("+t+")":e<0x10?"m_locals["+(e-1)+"]="+t:"setWord("+t+","+(this.m_vars_start+2*(e-16))+")"},_generate_gosub:function(t,arguments,e){this.m_compilation_running=0;var _=-1;return e&&(_=this.m_memory[this.m_pc++]),"_func_gosub("+this.m_pc_translate_for_routine(t)+",["+arguments.toString()+"],"+this.m_pc+","+_+")"},_handler_zOut:function(t,e){return"if(_zOut("+t+")){"+(e?"_func_return(1)":"m_pc=0x"+this.m_pc.toString(16))+";m_effects=["+GNUSTO_EFFECT_FLAGS_CHANGED+"];return 1}"},_handler_print:function(t,e){var _=this._zscii_from(this.m_pc,65535,1),r=_[0];return t&&(r+=t),r=r.quote(),this.m_pc=_[1],this._handler_zOut(r,e)},_log_shift:function(t,e){return 0x8000&e?t>>>0x10000-e&0xFFFF:t<<e&0xFFFF},_art_shift:function(t,e){return t=this._unsigned2signed(t),0x8000&e?t>>0x10000-e&0xFFFF:t<<e&0xFFFF},_touch:function(t){this.m_goldenTrail&&this.logger("pc",t.toString(16)),this.m_pc=t},_save_undo:function(t){return this.m_undo.push({m_call_stack:this.m_call_stack.slice(),m_func_stack:this.m_func_stack.slice(),m_locals:this.m_locals.slice(),m_locals_stack:this.m_locals_stack.slice(),m_param_counts:this.m_param_counts.slice(),m_result_targets:this.m_result_targets.slice(),m_gamestack:this.m_gamestack.slice(),m_gamestack_callbreaks:this.m_gamestack_callbreaks.slice(),m_memory:this.m_memory.slice(0,this.m_stat_start),m_resultvar:this.m_memory[t],m_pc:t+1}),1},_restore_undo:function(){if(0==this.m_undo.length)return 0;var t=this.m_undo.pop();this.m_call_stack=t.m_call_stack,this.m_func_stack=t.m_func_stack,this.m_locals=t.m_locals,this.m_locals_stack=t.m_locals_stack,this.m_param_counts=t.m_param_counts,this.m_result_targets=t.m_result_targets,this.m_gamestack=t.m_gamestack,this.m_gamestack_callbreaks=t.m_gamestack_callbreaks;var e=t.m_memory;return this.m_memory=e.concat(this.m_memory.slice(e.length)),this._varcode_set(2,t.m_resultvar),this.m_pc=t.m_pc,1},_saveable_state:function(t){return{m_memory:this.m_memory.slice(0,this.m_stat_start),m_pc:this.m_pc+t,m_call_stack:this.m_call_stack.slice(),m_func_stack:this.m_func_stack.slice(),m_locals:this.m_locals.slice(),m_locals_stack:this.m_locals_stack.slice(),m_param_counts:this.m_param_counts.slice(),m_result_targets:this.m_result_targets.slice(),m_gamestack:this.m_gamestack.slice(),m_gamestack_callbreaks:this.m_gamestack_callbreaks.slice()}},_verify:function(){for(var t=0,e=this.m_original_memory[0x1c]<<8|this.m_original_memory[0x1d],_=0x40;_<this.m_original_memory.length;_++)t+=this.m_original_memory[_];return(0xFFFF&t)==e},m_local_game_file:0,m_memory:[],m_handlers:0,m_jit:[],m_goldenTrail:0,m_copperTrail:0,m_compilation_running:0,m_gamestack:0,m_gamestack_callbreaks:[],m_himem:0,m_pc:0,m_dict_start:0,m_objs_start:0,m_vars_start:0,m_stat_start:0,m_abbr_start:0,m_hext_start:0,m_alpha_start:0,m_zalphabet:[],m_string_start:0,m_routine_start:0,m_unicode_start:0,m_custom_unicode_charcount:0,m_separator_count:0,m_separators:[],m_version:0,m_call_stack:[],m_func_stack:[],m_locals:[],m_locals_stack:0,m_param_counts:0,m_result_targets:[],m_rebound:0,m_rebound_args:[],m_output_to_console:0,m_streamthrees:[],m_output_to_script:0,m_single_step:0,m_debug_mode:0,m_parser_debugging:0,m_value_asserts:0,m_breakpoints:{},m_console_buffer:"",m_transcript_buffer:"",m_effects:[],m_answers:[],m_random_state:0,m_random_use_seed:0,m_random_use_sequence:0,m_random_sequence_max:0,m_printing_header_bits:0,m_leftovers:"",m_pc_translate_for_routine:pc_translate_v45,m_pc_translate_for_string:pc_translate_v45,m_undo:[],m_state_to_save:0,m_quetzal_image:0,m_original_memory:[],m_object_tree_start:0,m_property_list_addr_start:0,m_object_size:14,m_interrupt_information:[],op_parchment_data:{}};